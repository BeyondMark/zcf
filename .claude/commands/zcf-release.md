# ZCF Release - Automated Release and Commit

Automate version release and code commit using changeset.

## Usage

```bash
/zcf-release [-p|-mi|-ma]
```

## Parameters

- `-p` or `--patch`: Patch version (default) - bug fixes, minor changes
- `-mi` or `--minor`: Minor version - new features, backward compatible
- `-ma` or `--major`: Major version - breaking changes, incompatible

## Context

- Automatically analyze code changes and generate bilingual CHANGELOG
- Use changeset for version management
- Auto commit code and create release tags
- Support GitHub Actions auto publish to npm

## Your Role

You are a professional release management assistant responsible for:

1. Analyzing code changes
2. Generating standardized CHANGELOG
3. Executing version release process

## Execution Flow

Parse arguments: $ARGUMENTS

### 1. Parameter Parsing

```bash
VERSION_TYPE="patch"  # Default to patch version

case "$ARGUMENTS" in
  -p|--patch)
    VERSION_TYPE="patch"
    ;;
  -mi|--minor)
    VERSION_TYPE="minor"
    ;;
  -ma|--major)
    VERSION_TYPE="major"
    ;;
  "")
    VERSION_TYPE="patch"
    ;;
  *)
    echo "Unknown parameter: $ARGUMENTS"
    echo "Usage: /zcf-release [-p|-mi|-ma]"
    exit 1
    ;;
esac

echo "🚀 Preparing to release $VERSION_TYPE version"
```

### 2. Check Working Directory Status

Check if the current working directory meets release conditions:

```bash
# Ensure in project root directory
if [ ! -f "package.json" ]; then
  echo "❌ Error: package.json not found, please run in project root"
  exit 1
fi

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "⚠️  Detected uncommitted changes:"
  git status --short
  echo ""
  read -p "Commit these changes first? [Y/n] " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
    echo "Please commit changes before releasing"
    exit 1
  fi
fi

echo "✅ Working directory status OK"
```

### 3. Analyze Version Changes

Analyze all changes since last release:

```bash
# Get last release tag
LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

if [ -z "$LAST_TAG" ]; then
  echo "📊 No previous version tag found, analyzing all commits"
  COMMITS=$(git log --oneline)
else
  echo "📊 Last version: $LAST_TAG"
  echo "Analyzing changes since $LAST_TAG..."
  COMMITS=$(git log $LAST_TAG..HEAD --oneline)
fi

# Show commit history
echo -e "\n📝 Changes:"
echo "$COMMITS"

# Analyze file changes
echo -e "\n📁 File change statistics:"
if [ -z "$LAST_TAG" ]; then
  git diff --stat
else
  git diff --stat $LAST_TAG..HEAD
fi
```

### 4. Generate CHANGELOG Content

Based on code change analysis, I will generate CHANGELOG following these standards:

**Format Requirements**:

1. Chinese description first, English description second
2. No mixing Chinese and English on the same line
3. Organize by category: New Features, Optimization, Fixes, Documentation, etc.
4. Each entry should be concise and clear

**Example Format**:

```markdown
## 新功能

- 添加技术执行指南文档，提供命令执行最佳实践
- 支持自动化发版命令 /zcf-release
- Windows 路径自动加引号处理

## New Features

- Add technical execution guidelines with command best practices
- Support automated release command /zcf-release
- Automatic quote handling for Windows paths

## 优化

- 优先使用 ripgrep 提升搜索性能
- 改进模板文件组织结构

## Optimization

- Prioritize ripgrep for better search performance
- Improve template file organization

## 修复

- 修复 Windows 路径反斜杠丢失问题

## Fixes

- Fix Windows path backslash escaping issue
```

### 5. Create Changeset

Create changeset file based on analysis:

```bash
# Generate timestamp
TIMESTAMP=$(date +%Y%m%d%H%M%S)
CHANGESET_FILE=".changeset/release-$TIMESTAMP.md"

# Create changeset file
echo "📝 Creating changeset file..."
cat > "$CHANGESET_FILE" << 'EOF'
---
"zcf": $VERSION_TYPE
---

[Bilingual CHANGELOG content generated based on actual changes]
EOF

echo "✅ Changeset file created: $CHANGESET_FILE"
```

### 6. Update Version Number

Use changeset to update version number and CHANGELOG:

```bash
echo "🔄 Updating version number and CHANGELOG..."
pnpm changeset version

# Get new version number
NEW_VERSION=$(node -p "require('./package.json').version")
echo "📦 New version: v$NEW_VERSION"

# Show CHANGELOG update
echo -e "\n📋 CHANGELOG has been updated, please review the content"
```

### 7. Create Release Commit

Commit all changes:

````bash
echo "💾 Committing release changes..."

# Add all changes
git add .

# Create release commit
git commit -m "chore: release v$NEW_VERSION

- Update version to $NEW_VERSION
- Update CHANGELOG.md
- Generated by /zcf-release command"

### 8. Push to Remote Repository

```bash
echo "🚀 Pushing to remote repository..."

# Push main branch
git push origin main

echo -e "\n✅ Release preparation complete!"
echo "📦 Version v$NEW_VERSION is ready"
echo "🤖 GitHub Actions will automatically publish to npm"
echo "👀 View release status: https://github.com/UfoMiao/zcf/actions"
````

## Complete Workflow Summary

1. **Preparation Phase**: Check parameters, working directory status
2. **Analysis Phase**: Analyze commit history and file changes
3. **Generation Phase**: Create bilingual CHANGELOG
4. **Execution Phase**: Update version, commit, push
5. **Release Phase**: GitHub Actions auto publish

## Important Notes

- Ensure all code has been tested
- CHANGELOG must follow bilingual format standards
- Choose the correct version type
- Carefully review CHANGELOG content before release

---

**Now starting release process...**
